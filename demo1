const fs = require("fs");
const path = require("path");
const esbuild = require("esbuild");

const buildDir = path.join(__dirname, "build");
if (!fs.existsSync(buildDir)) {
    console.log("Building the React app...");
    require("child_process").execSync("npm run build", { stdio: "inherit" });
}

// Find the actual JS file with the hash
const jsDir = path.join(buildDir, "static/js");
const jsFiles = fs.readdirSync(jsDir).filter(file => file.endsWith(".js"));
if (jsFiles.length === 0) {
    console.error("❌ No JavaScript files found in build/static/js/. Exiting.");
    process.exit(1);
}

const mainJsFile = path.join(jsDir, jsFiles[0]);
console.log(`Using JavaScript file: ${mainJsFile}`);

// Bundle JavaScript
console.log("Bundling JavaScript...");
esbuild.buildSync({
    entryPoints: [mainJsFile],
    bundle: true,
    minify: true,
    outfile: path.join(__dirname, "dist", "app.min.js"),
});

const jsContent = fs.readFileSync(path.join(__dirname, "dist", "app.min.js"), "utf-8");

// Inline CSS
console.log("Inlining CSS...");
const cssDir = path.join(buildDir, "static/css");
const cssFiles = fs.readdirSync(cssDir).filter(file => file.endsWith(".css"));
let cssContent = "";
cssFiles.forEach(file => {
    cssContent += fs.readFileSync(path.join(cssDir, file), "utf-8");
});

// Generate Single HTML File
console.log("Creating single-file.html...");
const htmlTemplate = fs.readFileSync(path.join(buildDir, "index.html"), "utf-8");
const inlinedHTML = htmlTemplate
    .replace(/<link[^>]+href="\/static\/css\/[^"]+"[^>]*>/, `<style>${cssContent}</style>`)
    .replace(/<script[^>]+src="\/static\/js\/[^"]+"[^>]*><\/script>/, `<script>${jsContent}</script>`);

const outputDir = path.join(__dirname, "dist");
if (!fs.existsSync(outputDir)) fs.mkdirSync(outputDir);

fs.writeFileSync(path.join(outputDir, "single-file.html"), inlinedHTML);

console.log("✅ Single HTML file created: dist/single-file.html");

import styled from "styled-components";
import { FormControl, Dropdown, Modal, Button } from "react-bootstrap";
import { useState } from "react";
import { useQuerySuggestions } from "./useQuerySuggestions";

const SearchContainer = styled.div`
  position: relative;
  width: 300px;
`;

const StyledInput = styled(FormControl)`
  font-size: 16px;
  padding: 8px;
`;

const SuggestionsDropdown = styled(Dropdown.Menu)`
  width: 100%;
  max-height: 200px;
  overflow-y: auto;
  position: absolute;
  z-index: 1000;
`;

const SuggestionItem = styled(Dropdown.Item)<{ isActive: boolean }>`
  background: ${({ isActive }) => (isActive ? "#ddd" : "white")};
  color: ${({ isActive }) => (isActive ? "black" : "#666")};
`;

const AutocompleteText = styled.span`
  color: gray;
  position: absolute;
  pointer-events: none;
`;

const SearchInput: React.FC = () => {
  const { suggestQueries, suggestions, currentSuggestion, nextSuggestion, prevSuggestion } = useQuerySuggestions();
  const [query, setQuery] = useState("");
  const [showDropdown, setShowDropdown] = useState(false);
  const [showModal, setShowModal] = useState(false);

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setQuery(value);
    suggestQueries(value);
    setShowDropdown(value.length > 0);
  };

  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === "ArrowDown") {
      nextSuggestion();
    } else if (e.key === "ArrowUp") {
      prevSuggestion();
    } else if (e.key === "Tab" && currentSuggestion) {
      e.preventDefault();
      setQuery(query + currentSuggestion);
    }
  };

  return (
    <>
      <SearchContainer>
        <StyledInput
          type="text"
          value={query}
          onChange={handleInputChange}
          onKeyDown={handleKeyDown}
          placeholder="Search..."
        />
        {currentSuggestion && <AutocompleteText>{query + currentSuggestion}</AutocompleteText>}
        
        {showDropdown && (
          <SuggestionsDropdown show>
            {suggestions.map((sugg, index) => (
              <SuggestionItem key={sugg} isActive={sugg === currentSuggestion}>
                {sugg}
              </SuggestionItem>
            ))}
          </SuggestionsDropdown>
        )}
      </SearchContainer>

      <Button variant="primary" onClick={() => setShowModal(true)}>Open Search</Button>

      <Modal show={showModal} onHide={() => setShowModal(false)}>
        <Modal.Header closeButton>
          <Modal.Title>Search</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <StyledInput
            type="text"
            value={query}
            onChange={handleInputChange}
            onKeyDown={handleKeyDown}
            placeholder="Search..."
          />
        </Modal.Body>
      </Modal>
    </>
  );
};

export default SearchInput;

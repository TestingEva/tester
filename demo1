import { useEffect, useMemo, useState } from "react";
import { IGMPInfo } from "../../../data/tr181/models";
import {
  useIGMPInfo,
  useRoutingInfo,
  useUpdateIGMPInfo,
  useUpdateRoutingInfo,
} from "../../../domain/routing/hooks";
import { ErrorIndicator } from "../../components/error-indicator/ErrorIndicator";
import { LoadingIndicator } from "../../components/loading-indicator/LoadingIndicator";
import { RoutingView } from "./RoutingView";

export const Routing: React.FC = () => {
  const { data, isPending, isError } = useRoutingInfo();
  const {
    data: igmpInfo,
    isPending: isIgmpPending,
    isError: isIgmpError,
    isFetching: isIgmpFetching,
  } = useIGMPInfo();
  const {
    invoke,
    isError: updateError,
    isPending: isUpdating,
  } = useUpdateRoutingInfo();
  const {
    invoke: updateIgmpInfo,
    isError: isIgmpUpdateError,
    isPending: isIgmpUpdating,
  } = useUpdateIGMPInfo();
  const [currentData, setCurrentData] = useState<IGMPInfo>();

  const isApplyButtonEnabled = useMemo(() => {
    if (currentData !== undefined && igmpInfo !== undefined) {
      return Object.keys(findDifferences(currentData, igmpInfo)).length !== 0;
    } else {
      return true;
    }
  }, [igmpInfo, currentData]);

  useEffect(() => {
    if (igmpInfo !== undefined) {
      setCurrentData(igmpInfo);
    }
  }, [isIgmpFetching, igmpInfo]);

  const onCheckboxChange = (key: keyof IGMPInfo) => {
    setCurrentData((prevData) => ({
      ...prevData!,
      [key]: !prevData![key],
    }));
  };

  const onRemoveButtonClick = (index: number) => {
    invoke({ id: index, type: 1 });
  };

  const onApplyButtonClicked = () => {
    if (currentData !== undefined && igmpInfo !== undefined) {
      const changes = findDifferences(currentData, igmpInfo);
      updateIgmpInfo(changes);
    }
  };

  if (isError || updateError || isIgmpError || isIgmpUpdateError) {
    return <ErrorIndicator />;
  }

  if (
    isPending ||
    currentData === undefined ||
    data === undefined ||
    isIgmpPending
  ) {
    return <LoadingIndicator />;
  }

  return (
    <RoutingView
      routingTableData={data}
      igmpData={currentData}
      onCheckboxChange={onCheckboxChange}
      onApplyButtonClicked={onApplyButtonClicked}
      isApplyButtonEnabled={!isApplyButtonEnabled}
      isUpdating={isUpdating || isIgmpUpdating}
      onRemoveButtonClick={onRemoveButtonClick}
    />
  );
};

// Helper function to find differences between two objects
function findDifferences<T extends object>(obj1: T, obj2: T): Partial<T> {
  const changes: Partial<T> = {};
  (Object.keys(obj1) as (keyof T)[]).forEach((key) => {
    if (obj1[key] !== obj2[key]) {
      changes[key] = obj1[key];
    }
  });
  return changes;
}

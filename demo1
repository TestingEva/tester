export const QswPage: React.FC<{ fromLoginPage?: boolean }> = ({ fromLoginPage }) => {
  const { logShaEvent } = useEventLogger();
  const provider = useMessageProvider();
  const { data: qswData, isError } = useQswDetails();
  const {
    invoke: updateQsw,
    isPending: isApplying,
    isSuccess: isUpdateSuccess,
    isError: isUpdatedFailed,
  } = useUpdateQswDetails();
  const { data: showWarnPrompt, isError: isShowWarnPromptError } = useWarnPromptsEnabled();
  const { invoke: logout } = useClearSession();
  const navigate = useNavigator();
  const locator = useLocator();

  const [showModal, setShowModal] = useState(false);
  const modalTimerRef = useRef<NodeJS.Timeout | null>(null);

  useEffect(() => {
    if (locator.state?.isRoleAutoDetected) {
      setShowModal(true);
      modalTimerRef.current = setTimeout(() => {
        setShowModal(false);
      }, 5000);
    }

    return () => {
      if (modalTimerRef.current) {
        clearTimeout(modalTimerRef.current);
      }
    };
  }, [locator.state?.isRoleAutoDetected]);

  const qswFormDetails = useMemo(() => {
    if (qswData !== undefined) {
      return convertQswDetailsToModel(qswData, fromLoginPage ?? false);
    }
  }, [qswData, fromLoginPage]);

  const update = (changedValues: Partial<QswModel>) => {
    if (qswData !== undefined) {
      const payload: UpdateQswDetails = {
        qswSessionId: qswData.qswSessionId,
      };

      if (changedValues.primaryPass !== undefined || changedValues.primarySsid !== undefined) {
        payload.primaryWifi = {
          ssid: changedValues.primarySsid,
          password: changedValues.primaryPass,
          radioType: qswData.primaryWifi.radioType,
        };
      }

      if (
        qswData.guestWifi !== undefined &&
        (changedValues.guestSsid !== undefined ||
          changedValues.guestEnable !== undefined ||
          changedValues.guestPass !== undefined)
      ) {
        payload.guestWifi = {
          ssid: changedValues.guestSsid,
          password: changedValues.guestPass,
          enabled: changedValues.guestEnable,
          radioType: qswData.guestWifi.radioType,
        };
      }

      if (qswData.sixGhzWifi !== undefined && changedValues.sixGhzEnable !== undefined) {
        payload.sixGhz = {
          enabled: changedValues.sixGhzEnable,
          radioType: qswData.sixGhzWifi.radioType,
        };
      }
      updateQsw(payload);
    }
  };

  const navigateToHome = () => navigate(RouteType.HOME, { mode: ContentMode.Basic });

  useEffect(() => {
    if (!isApplying) logShaEvent(shaEvents.qswPage);
    //eslint-disable-next-line
  }, []);

  if (isError || isShowWarnPromptError) {
    return fromLoginPage ? (
      <Container fluid className="vh-100 overflow-auto loginPage--full--page--container d-flex justify-content-center">
        <ErrorIndicator />
      </Container>
    ) : (
      <ErrorIndicator />
    );
  }

  if (qswFormDetails === undefined || qswData === undefined || showWarnPrompt === undefined) {
    return fromLoginPage ? (
      <Container fluid className="vh-100 overflow-auto loginPage--full--page--container">
        <LoadingIndicator />
      </Container>
    ) : (
      <LoadingIndicator />
    );
  }

  return (
    <>
      <ModalInfo show={showModal} />
      {fromLoginPage ? (
        <Container fluid className="vh-100 overflow-auto loginPage--full--page--container">
          <Topbar useContentFilter={false} showProfile={false} />
          <Container className="loginpage--main--container d-flex">
            <QswPageView
              qswDetails={qswFormDetails}
              updateValues={update}
              showWarnModal={showWarnPrompt}
              isApplying={isApplying}
              fromLoginPage={fromLoginPage}
              navigateToHome={navigateToHome}
              isUpdateSuccess={isUpdateSuccess}
              isUpdatedFailed={isUpdatedFailed}
              navigateToLogin={logout}
              provider={provider}
            />
          </Container>
        </Container>
      ) : (
        <QswPageView
          qswDetails={qswFormDetails}
          updateValues={update}
          showWarnModal={showWarnPrompt}
          isApplying={isApplying}
          fromLoginPage={fromLoginPage}
          navigateToHome={navigateToHome}
          isUpdateSuccess={isUpdateSuccess}
          isUpdatedFailed={isUpdatedFailed}
          navigateToLogin={logout}
          provider={provider}
        />
      )}
    </>
  );
};
